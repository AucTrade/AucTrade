<!DOCTYPE html>
<html>
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <script src="https://code.jquery.com/jquery-2.2.1.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

<div class="container">
    <div class="row">
        <div class="col-8" >
            <div class="row" id="title"></div>
            <hr>
            <div class="row"><h2>현재 낙찰가</h2></div>
            <div class="row" id="price"></div>
        </div>
        <div class="col-4">
            <div class="row"><h3>채팅창</h3></div>
            <div class="overflow-y bg-success" id="msgArea" style="height: 500px; padding: 10px; --bs-bg-opacity: .5;"></div>
            <div>
                <div class="input-group mb-3">
                    <input type="text" id="msg" class="form-control">
                    <div class="input-group-append">
                        <button class="btn btn-outline-secondary" type="button" id="button-send">전송</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

</body>
<script>
    var username = '';
    var roomId = '';
   $(document).ready(function(){
     username = prompt("what's your name?");
     $.ajax({
       url : `/api/chat/room?roomId=${getUrlParams()["roomId"]}`,
       type : 'get',
       contentType: "application/json; charset=UTF-8",
       success : function (result) {
           document.querySelector('#title').innerHTML = `<h1>${result.title}</h1>`;
           roomId = result.id;
           socket(result.id, username);
       },
       error : function (request, status, error) {
           console.log(error);
       }
       });
   })

    function getUrlParams() {
       var params = {};
       window.location.search.replace(/[?&]+([^=&]+)=([^&]*)/gi,
           function(str, key, value) {
               params[key] = value;
           }
       );
       return params;
   }
   function createMsg(content){
         var writer = content.name;
         var message = content.msg;

         if(/^@[0-9]+/.test(message)){
           document.querySelector('#price').innerHTML = `<h3>${message.substring(1)}</h3>`;

           document.querySelector('#msgArea').innerHTML +=
           `<div class='row h-auto'><div class='alert alert-warning h-auto'><b>${writer} : ${message}</b></div></div>`;
         }else{
           var color = (username == content.name) ? "text-success" : "text-body";
           document.querySelector('#msgArea').innerHTML += `<div class='w-100 h-auto d-inline-block text-wrap'><p class="${color} text-wrap">${writer} : ${message}</p></div>`;
         }
   }

    function socket(roomId, username){
     var sockJs = new SockJS("/stomp/chat");
     //1. SockJS를 내부에 들고있는 stomp를 내어줌
     var stomp = Stomp.over(sockJs);

     //2. connection이 맺어지면 실행
     stomp.connect({}, function (){
       console.log("STOMP Connection")

       //4. subscribe(path, callback)으로 메세지를 받을 수 있음
       stomp.subscribe("/sub/chat/room/" + roomId, (chat) => createMsg(JSON.parse(chat.body)));

       //3. send(path, header, message)로 메세지를 보낼 수 있음
       stomp.send('/send/chat/enter', {}, JSON.stringify({roomId: roomId, name: username}))
     });

     $("#button-send").on("click", function(e){
       var msg = document.getElementById("msg");
       stomp.send('/send/chat/message', {}, JSON.stringify({roomId: roomId,msg: msg.value,name: username}));
       msg.value = '';
     });
   }
</script>
</html>